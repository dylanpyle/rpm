function Xe(e,t,s){e.translate(t.width/2,t.height/2),e.rotate(s),e.translate(-t.width/2,-t.height/2)}function Ke(e,t,s){e.fillStyle=s,e.fillRect(0,0,t.width,t.height)}function Qe(e,t,s,a){e.save(),e.beginPath(),e.arc(t.width/2,t.height/2,t.width/2-a,0,Math.PI*2),e.clip(),e.drawImage(s,a,a,t.width-a*2,t.height-a*2),e.restore()}function Ze(e,t,s,a){let n=(t.width-s*2)/32;e.beginPath(),e.arc(t.width/2,t.height/2,n,0,Math.PI*2),e.fillStyle=a,e.fill()}var Et=Date.now(),It=60*1e3,Ye=Math.PI*2,Y=class{options;ctx;canvas;croppedImageBuffer;croppedImageCtx;isRunning=!1;constructor(t,s){this.canvas=t;let a=t.getContext("2d",{willReadFrequently:!0});if(!a)throw new Error("Error getting context");this.ctx=a,this.options=s,this.croppedImageBuffer=document.createElement("canvas"),this.croppedImageBuffer.width=a.canvas.width,this.croppedImageBuffer.height=a.canvas.height;let r=this.croppedImageBuffer.getContext("2d");if(!r)throw new Error("Error getting buffer context");this.croppedImageCtx=r,this.options.image.addEventListener("load",this.onImageLoad)}renderFrame(t){let{options:s,ctx:a,canvas:r}=this;a.resetTransform(),Ke(a,r,s.backgroundColor),Xe(a,r,t),Qe(a,r,this.croppedImageBuffer,this.getPaddingPx()),s.showCenterHole&&Ze(a,r,this.getPaddingPx(),s.backgroundColor)}renderLoop=()=>{let{isRunning:t}=this;if(!t)return;let s=this.getRotationAngle();this.renderFrame(s),requestAnimationFrame(this.renderLoop)};getPaddingPx(){return this.options.paddingPercent/100*this.ctx.canvas.width}getRotationAngle(){let s=(Date.now()-Et)/It*this.options.speedRpm;return Ye*s%Ye}onImageLoad=()=>{let{image:t}=this.options;if(!this.croppedImageCtx)return;let s=t.width/t.height,a=this.canvas.width,r=this.canvas.height;s>1?a=this.canvas.width*s:r=this.canvas.height/s;let n=(this.canvas.width-a)/2,u=(this.canvas.height-r)/2;this.croppedImageCtx.drawImage(t,n,u,a,r)};start(){this.isRunning=!0,this.renderLoop()}stop(){this.isRunning=!1}getImageData(){return this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height).data}};var Be=(e,t,s)=>{if(!t.has(e))throw TypeError("Cannot "+s)},i=(e,t,s)=>(Be(e,t,"read from private field"),s?s.call(e):t.get(e)),f=(e,t,s)=>{if(t.has(e))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(e):t.set(e,s)},C=(e,t,s,a)=>(Be(e,t,"write to private field"),a?a.call(e,s):t.set(e,s),s),kt=(e,t,s,a)=>({set _(r){C(e,t,r,s)},get _(){return i(e,t,a)}}),m=(e,t,s)=>(Be(e,t,"access private method"),s),c=new Uint8Array(8),L=new DataView(c.buffer),I=e=>[(e%256+256)%256],p=e=>(L.setUint16(0,e,!1),[c[0],c[1]]),At=e=>(L.setInt16(0,e,!1),[c[0],c[1]]),et=e=>(L.setUint32(0,e,!1),[c[1],c[2],c[3]]),o=e=>(L.setUint32(0,e,!1),[c[0],c[1],c[2],c[3]]),F=e=>(L.setUint32(0,Math.floor(e/2**32),!1),L.setUint32(4,e,!1),[c[0],c[1],c[2],c[3],c[4],c[5],c[6],c[7]]),Oe=e=>(L.setInt16(0,2**8*e,!1),[c[0],c[1]]),B=e=>(L.setInt32(0,2**16*e,!1),[c[0],c[1],c[2],c[3]]),ye=e=>(L.setInt32(0,2**30*e,!1),[c[0],c[1],c[2],c[3]]),k=(e,t=!1)=>{let s=Array(e.length).fill(null).map((a,r)=>e.charCodeAt(r));return t&&s.push(0),s},H=e=>e&&e[e.length-1],x=(e,t,s=!0)=>{let a=e*t;return s?Math.round(a):a},tt=e=>{let t=e*(Math.PI/180),s=Math.cos(t),a=Math.sin(t);return[s,a,0,-a,s,0,0,0,1]},Mt=tt(0),it=e=>[B(e[0]),B(e[1]),ye(e[2]),B(e[3]),B(e[4]),ye(e[5]),B(e[6]),B(e[7]),ye(e[8])],ee=e=>!e||typeof e!="object"?e:Array.isArray(e)?e.map(ee):Object.fromEntries(Object.entries(e).map(([t,s])=>[t,ee(s)])),X=e=>e>=0&&e<2**32,w=(e,t,s)=>({type:e,contents:t&&new Uint8Array(t.flat(10)),children:s}),v=(e,t,s,a,r)=>w(e,[I(t),et(s),a??[]],r),zt=e=>{let t=512;return e.fragmented?w("ftyp",[k("iso5"),o(t),k("iso5"),k("iso6"),k("mp41")]):w("ftyp",[k("isom"),o(t),k("isom"),e.holdsAvc?k("avc1"):[],k("mp41")])},Te=e=>({type:"mdat",largeSize:e}),Bt=e=>({type:"free",size:e}),le=(e,t,s=!1)=>w("moov",null,[Ot(t,e),...e.map(a=>Lt(a,t)),s?ri(e):null]),Ot=(e,t)=>{let s=x(Math.max(0,...t.filter(u=>u.samples.length>0).map(u=>H(u.samples).timestamp+H(u.samples).duration)),Ee),a=Math.max(...t.map(u=>u.id))+1,r=!X(e)||!X(s),n=r?F:o;return v("mvhd",+r,0,[n(e),n(e),o(Ee),n(s),B(1),Oe(1),Array(10).fill(0),it(Mt),Array(24).fill(0),o(a)])},Lt=(e,t)=>w("trak",null,[xt(e,t),Ut(e,t)]),xt=(e,t)=>{let s=H(e.samples),a=x(s?s.timestamp+s.duration:0,Ee),r=!X(t)||!X(a),n=r?F:o;return v("tkhd",+r,3,[n(t),n(t),o(e.id),o(0),n(a),Array(8).fill(0),p(0),p(0),Oe(e.info.type==="audio"?1:0),p(0),it(tt(e.info.type==="video"?e.info.rotation:0)),B(e.info.type==="video"?e.info.width:0),B(e.info.type==="video"?e.info.height:0)])},Ut=(e,t)=>w("mdia",null,[Dt(e,t),Pt(e.info.type==="video"?"vide":"soun"),Rt(e)]),Dt=(e,t)=>{let s=H(e.samples),a=x(s?s.timestamp+s.duration:0,e.timescale),r=!X(t)||!X(a),n=r?F:o;return v("mdhd",+r,0,[n(t),n(t),o(e.timescale),n(a),p(21956),p(0)])},Pt=e=>v("hdlr",0,0,[k("mhlr"),k(e),o(0),o(0),o(0),k("mp4-muxer-hdlr",!0)]),Rt=e=>w("minf",null,[e.info.type==="video"?Wt():Ft(),Ht(),qt(e)]),Wt=()=>v("vmhd",0,1,[p(0),p(0),p(0),p(0)]),Ft=()=>v("smhd",0,0,[p(0),p(0)]),Ht=()=>w("dinf",null,[Nt()]),Nt=()=>v("dref",0,0,[o(1)],[Vt()]),Vt=()=>v("url ",0,1),qt=e=>w("stbl",null,[$t(e),ei(e),ti(e),ii(e),si(e),ai(e)]),$t=e=>v("stsd",0,0,[o(1)],[e.info.type==="video"?jt(pi[e.info.codec],e):Zt(gi[e.info.codec],e)]),jt=(e,t)=>w(e,[Array(6).fill(0),p(1),p(0),p(0),Array(12).fill(0),p(t.info.width),p(t.info.height),o(4718592),o(4718592),o(0),p(1),Array(32).fill(0),p(24),At(65535)],[vi[t.info.codec](t)]),Gt=e=>e.codecPrivate&&w("avcC",[...e.codecPrivate]),Xt=e=>e.codecPrivate&&w("hvcC",[...e.codecPrivate]),Kt=e=>e.codecPrivate&&w("vpcC",[...e.codecPrivate]),Qt=e=>e.codecPrivate&&w("av1C",[...e.codecPrivate]),Zt=(e,t)=>w(e,[Array(6).fill(0),p(1),p(0),p(0),o(0),p(t.info.numberOfChannels),p(16),p(0),p(0),B(t.info.sampleRate)],[wi[t.info.codec](t)]),Yt=e=>v("esds",0,0,[o(58753152),I(32+e.codecPrivate.byteLength),p(1),I(0),o(75530368),I(18+e.codecPrivate.byteLength),I(64),I(21),et(0),o(130071),o(130071),o(92307584),I(e.codecPrivate.byteLength),...e.codecPrivate,o(109084800),I(1),I(2)]),Jt=e=>w("dOps",[I(0),I(e.info.numberOfChannels),p(3840),o(e.info.sampleRate),Oe(0),I(0)]),ei=e=>v("stts",0,0,[o(e.timeToSampleTable.length),e.timeToSampleTable.map(t=>[o(t.sampleCount),o(t.sampleDelta)])]),ti=e=>{if(e.samples.every(s=>s.type==="key"))return null;let t=[...e.samples.entries()].filter(([,s])=>s.type==="key");return v("stss",0,0,[o(t.length),t.map(([s])=>o(s+1))])},ii=e=>v("stsc",0,0,[o(e.compactlyCodedChunkTable.length),e.compactlyCodedChunkTable.map(t=>[o(t.firstChunk),o(t.samplesPerChunk),o(1)])]),si=e=>v("stsz",0,0,[o(0),o(e.samples.length),e.samples.map(t=>o(t.size))]),ai=e=>e.finalizedChunks.length>0&&H(e.finalizedChunks).offset>=2**32?v("co64",0,0,[o(e.finalizedChunks.length),e.finalizedChunks.map(t=>F(t.offset))]):v("stco",0,0,[o(e.finalizedChunks.length),e.finalizedChunks.map(t=>o(t.offset))]),ri=e=>w("mvex",null,e.map(ni)),ni=e=>v("trex",0,0,[o(e.id),o(1),o(0),o(0),o(0)]),Je=(e,t)=>w("moof",null,[oi(e),...t.map(li)]),oi=e=>v("mfhd",0,0,[o(e)]),st=e=>{let t=0,s=0,a=0,r=0,n=e.type==="delta";return s|=+n,n?t|=1:t|=2,t<<24|s<<16|a<<8|r},li=e=>w("traf",null,[hi(e),ui(e),di(e)]),hi=e=>{let t=0;t|=8,t|=16,t|=32,t|=131072;let s=e.currentChunk.samples[1]??e.currentChunk.samples[0],a={duration:s.timescaleUnitsToNextSample,size:s.size,flags:st(s)};return v("tfhd",0,t,[o(e.id),o(a.duration),o(a.size),o(a.flags)])},ui=e=>v("tfdt",1,0,[F(x(e.currentChunk.startTimestamp,e.timescale))]),di=e=>{let t=e.currentChunk.samples.map(Q=>Q.timescaleUnitsToNextSample),s=e.currentChunk.samples.map(Q=>Q.size),a=e.currentChunk.samples.map(st),r=new Set(t),n=new Set(s),u=new Set(a),d=u.size===2&&a[0]!==a[1],g=r.size>1,T=n.size>1,q=!d&&u.size>1,M=0;return M|=1,M|=4*+d,M|=256*+g,M|=512*+T,M|=1024*+q,v("trun",0,M,[o(e.currentChunk.samples.length),o(e.currentChunk.offset-e.currentChunk.moofOffset||0),d?o(a[0]):[],e.currentChunk.samples.map((Q,_)=>[g?o(t[_]):[],T?o(s[_]):[],q?o(a[_]):[]])])},fi=e=>w("mfra",null,[...e.map(mi),ci()]),mi=(e,t)=>v("tfra",1,0,[o(e.id),o(63),o(e.finalizedChunks.length),e.finalizedChunks.map(a=>[F(x(a.startTimestamp,e.timescale)),F(a.moofOffset),o(t+1),o(1),o(1)])]),ci=()=>v("mfro",0,0,[o(0)]),pi={avc:"avc1",hevc:"hvc1",vp9:"vp09",av1:"av01"},vi={avc:Gt,hevc:Xt,vp9:Kt,av1:Qt},gi={aac:"mp4a",opus:"Opus"},wi={aac:Yt,opus:Jt},Le=class{constructor(){this.buffer=null}},at=class{constructor(e){this.options=e}},Ci=class{constructor(e,t){this.stream=e,this.options=t}},U,$,xe=class{constructor(){this.pos=0,f(this,U,new Uint8Array(8)),f(this,$,new DataView(i(this,U).buffer)),this.offsets=new WeakMap}seek(e){this.pos=e}writeU32(e){i(this,$).setUint32(0,e,!1),this.write(i(this,U).subarray(0,4))}writeU64(e){i(this,$).setUint32(0,Math.floor(e/2**32),!1),i(this,$).setUint32(4,e,!1),this.write(i(this,U).subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)i(this,$).setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.write(i(this,U));e.length%8!==0&&this.write(i(this,U).subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.pos),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.write(e.contents);else{let t=this.pos;if(this.writeBoxHeader(e,0),e.contents&&this.write(e.contents),e.children)for(let r of e.children)r&&this.writeBox(r);let s=this.pos,a=e.size??s-t;this.seek(t),this.writeBoxHeader(e,a),this.seek(s)}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}measureBoxHeader(e){return 8+(e.largeSize?8:0)}patchBox(e){let t=this.pos;this.seek(this.offsets.get(e)),this.writeBox(e),this.seek(t)}measureBox(e){if(e.contents&&!e.children)return this.measureBoxHeader(e)+e.contents.byteLength;{let t=this.measureBoxHeader(e);if(e.contents&&(t+=e.contents.byteLength),e.children)for(let s of e.children)s&&(t+=this.measureBox(s));return t}}};U=new WeakMap;$=new WeakMap;var he,W,ae,J,ue,_e,Si=class extends xe{constructor(e){super(),f(this,ue),f(this,he,void 0),f(this,W,new ArrayBuffer(2**16)),f(this,ae,new Uint8Array(i(this,W))),f(this,J,0),C(this,he,e)}write(e){m(this,ue,_e).call(this,this.pos+e.byteLength),i(this,ae).set(e,this.pos),this.pos+=e.byteLength,C(this,J,Math.max(i(this,J),this.pos))}finalize(){m(this,ue,_e).call(this,this.pos),i(this,he).buffer=i(this,W).slice(0,Math.max(i(this,J),this.pos))}};he=new WeakMap;W=new WeakMap;ae=new WeakMap;J=new WeakMap;ue=new WeakSet;_e=function(e){let t=i(this,W).byteLength;for(;t<e;)t*=2;if(t===i(this,W).byteLength)return;let s=new ArrayBuffer(t),a=new Uint8Array(s);a.set(i(this,ae),0),C(this,W,s),C(this,ae,a)};var de,D,rt=class extends xe{constructor(e){super(),f(this,de,void 0),f(this,D,[]),C(this,de,e)}write(e){i(this,D).push({data:e.slice(),start:this.pos}),this.pos+=e.byteLength}flush(){if(i(this,D).length===0)return;let e=[],t=[...i(this,D)].sort((s,a)=>s.start-a.start);e.push({start:t[0].start,size:t[0].data.byteLength});for(let s=1;s<t.length;s++){let a=e[e.length-1],r=t[s];r.start<=a.start+a.size?a.size=Math.max(a.size,r.start+r.data.byteLength-a.start):e.push({start:r.start,size:r.data.byteLength})}for(let s of e){s.data=new Uint8Array(s.size);for(let a of i(this,D))s.start<=a.start&&a.start<s.start+s.size&&s.data.set(a.data,a.start-s.start);i(this,de).options.onData?.(s.data,s.start)}i(this,D).length=0}finalize(){}};de=new WeakMap;D=new WeakMap;var yi=2**24,Ti=2,ce,A,E,pe,be,Ue,nt,De,ot,te,ve,lt=class extends xe{constructor(e){if(super(),f(this,pe),f(this,Ue),f(this,De),f(this,te),f(this,ce,void 0),f(this,A,void 0),f(this,E,[]),C(this,ce,e),C(this,A,e.options?.chunkSize??yi),!Number.isInteger(i(this,A))||i(this,A)<2**10)throw new Error("Invalid StreamTarget options: chunkSize must be an integer not smaller than 1024.")}write(e){m(this,pe,be).call(this,e,this.pos),m(this,te,ve).call(this),this.pos+=e.byteLength}finalize(){m(this,te,ve).call(this,!0)}};ce=new WeakMap;A=new WeakMap;E=new WeakMap;pe=new WeakSet;be=function(e,t){let s=i(this,E).findIndex(d=>d.start<=t&&t<d.start+i(this,A));s===-1&&(s=m(this,De,ot).call(this,t));let a=i(this,E)[s],r=t-a.start,n=e.subarray(0,Math.min(i(this,A)-r,e.byteLength));a.data.set(n,r);let u={start:r,end:r+n.byteLength};if(m(this,Ue,nt).call(this,a,u),a.written[0].start===0&&a.written[0].end===i(this,A)&&(a.shouldFlush=!0),i(this,E).length>Ti){for(let d=0;d<i(this,E).length-1;d++)i(this,E)[d].shouldFlush=!0;m(this,te,ve).call(this)}n.byteLength<e.byteLength&&m(this,pe,be).call(this,e.subarray(n.byteLength),t+n.byteLength)};Ue=new WeakSet;nt=function(e,t){let s=0,a=e.written.length-1,r=-1;for(;s<=a;){let n=Math.floor(s+(a-s+1)/2);e.written[n].start<=t.start?(s=n+1,r=n):a=n-1}for(e.written.splice(r+1,0,t),(r===-1||e.written[r].end<t.start)&&r++;r<e.written.length-1&&e.written[r].end>=e.written[r+1].start;)e.written[r].end=Math.max(e.written[r].end,e.written[r+1].end),e.written.splice(r+1,1)};De=new WeakSet;ot=function(e){let s={start:Math.floor(e/i(this,A))*i(this,A),data:new Uint8Array(i(this,A)),written:[],shouldFlush:!1};return i(this,E).push(s),i(this,E).sort((a,r)=>a.start-r.start),i(this,E).indexOf(s)};te=new WeakSet;ve=function(e=!1){for(let t=0;t<i(this,E).length;t++){let s=i(this,E)[t];if(!(!s.shouldFlush&&!e)){for(let a of s.written)i(this,ce).options.onData?.(s.data.subarray(a.start,a.end),s.start+a.start);i(this,E).splice(t--,1)}}};var _i=class extends lt{constructor(e){super(new at({onData:(t,s)=>e.stream.write({type:"write",data:t,position:s}),chunkSize:e.options?.chunkSize}))}},Ee=1e3,bi=["avc","hevc","vp9","av1"],Ei=["aac","opus"],Ii=2082844800,ki=["strict","offset"],h,l,ge,b,S,y,j,G,Pe,P,R,ie,Ie,ht,ke,ut,Re,dt,Ae,ft,We,mt,fe,Me,z,O,Fe,ct,se,we,Ce,He,K,re,me,ze,pt=class{constructor(e){if(f(this,Ie),f(this,ke),f(this,Re),f(this,Ae),f(this,We),f(this,fe),f(this,z),f(this,Fe),f(this,se),f(this,Ce),f(this,K),f(this,me),f(this,h,void 0),f(this,l,void 0),f(this,ge,void 0),f(this,b,void 0),f(this,S,null),f(this,y,null),f(this,j,Math.floor(Date.now()/1e3)+Ii),f(this,G,[]),f(this,Pe,1),f(this,P,[]),f(this,R,[]),f(this,ie,!1),m(this,Ie,ht).call(this,e),e.video=ee(e.video),e.audio=ee(e.audio),e.fastStart=ee(e.fastStart),this.target=e.target,C(this,h,{firstTimestampBehavior:"strict",...e}),e.target instanceof Le)C(this,l,new Si(e.target));else if(e.target instanceof at)C(this,l,e.target.options?.chunked?new lt(e.target):new rt(e.target));else if(e.target instanceof Ci)C(this,l,new _i(e.target));else throw new Error(`Invalid target: ${e.target}`);m(this,Ae,ft).call(this),m(this,ke,ut).call(this)}addVideoChunk(e,t,s){let a=new Uint8Array(e.byteLength);e.copyTo(a),this.addVideoChunkRaw(a,e.type,s??e.timestamp,e.duration,t)}addVideoChunkRaw(e,t,s,a,r){if(m(this,me,ze).call(this),!i(this,h).video)throw new Error("No video track declared.");if(typeof i(this,h).fastStart=="object"&&i(this,S).samples.length===i(this,h).fastStart.expectedVideoChunks)throw new Error(`Cannot add more video chunks than specified in 'fastStart' (${i(this,h).fastStart.expectedVideoChunks}).`);let n=m(this,fe,Me).call(this,i(this,S),e,t,s,a,r);if(i(this,h).fastStart==="fragmented"&&i(this,y)){for(;i(this,R).length>0&&i(this,R)[0].timestamp<=n.timestamp;){let u=i(this,R).shift();m(this,z,O).call(this,i(this,y),u)}n.timestamp<=i(this,y).lastTimestamp?m(this,z,O).call(this,i(this,S),n):i(this,P).push(n)}else m(this,z,O).call(this,i(this,S),n)}addAudioChunk(e,t,s){let a=new Uint8Array(e.byteLength);e.copyTo(a),this.addAudioChunkRaw(a,e.type,s??e.timestamp,e.duration,t)}addAudioChunkRaw(e,t,s,a,r){if(m(this,me,ze).call(this),!i(this,h).audio)throw new Error("No audio track declared.");if(typeof i(this,h).fastStart=="object"&&i(this,y).samples.length===i(this,h).fastStart.expectedAudioChunks)throw new Error(`Cannot add more audio chunks than specified in 'fastStart' (${i(this,h).fastStart.expectedAudioChunks}).`);let n=m(this,fe,Me).call(this,i(this,y),e,t,s,a,r);if(i(this,h).fastStart==="fragmented"&&i(this,S)){for(;i(this,P).length>0&&i(this,P)[0].timestamp<=n.timestamp;){let u=i(this,P).shift();m(this,z,O).call(this,i(this,S),u)}n.timestamp<=i(this,S).lastTimestamp?m(this,z,O).call(this,i(this,y),n):i(this,R).push(n)}else m(this,z,O).call(this,i(this,y),n)}finalize(){if(i(this,ie))throw new Error("Cannot finalize a muxer more than once.");if(i(this,h).fastStart==="fragmented"){for(let t of i(this,P))m(this,z,O).call(this,i(this,S),t);for(let t of i(this,R))m(this,z,O).call(this,i(this,y),t);m(this,Ce,He).call(this,!1)}else i(this,S)&&m(this,se,we).call(this,i(this,S)),i(this,y)&&m(this,se,we).call(this,i(this,y));let e=[i(this,S),i(this,y)].filter(Boolean);if(i(this,h).fastStart==="in-memory"){let t;for(let a=0;a<2;a++){let r=le(e,i(this,j)),n=i(this,l).measureBox(r);t=i(this,l).measureBox(i(this,b));let u=i(this,l).pos+n+t;for(let d of i(this,G)){d.offset=u;for(let{data:g}of d.samples)u+=g.byteLength,t+=g.byteLength}if(u<2**32)break;t>=2**32&&(i(this,b).largeSize=!0)}let s=le(e,i(this,j));i(this,l).writeBox(s),i(this,b).size=t,i(this,l).writeBox(i(this,b));for(let a of i(this,G))for(let r of a.samples)i(this,l).write(r.data),r.data=null}else if(i(this,h).fastStart==="fragmented"){let t=i(this,l).pos,s=fi(e);i(this,l).writeBox(s);let a=i(this,l).pos-t;i(this,l).seek(i(this,l).pos-4),i(this,l).writeU32(a)}else{let t=i(this,l).offsets.get(i(this,b)),s=i(this,l).pos-t;i(this,b).size=s,i(this,b).largeSize=s>=2**32,i(this,l).patchBox(i(this,b));let a=le(e,i(this,j));if(typeof i(this,h).fastStart=="object"){i(this,l).seek(i(this,ge)),i(this,l).writeBox(a);let r=t-i(this,l).pos;i(this,l).writeBox(Bt(r))}else i(this,l).writeBox(a)}m(this,K,re).call(this),i(this,l).finalize(),C(this,ie,!0)}};h=new WeakMap;l=new WeakMap;ge=new WeakMap;b=new WeakMap;S=new WeakMap;y=new WeakMap;j=new WeakMap;G=new WeakMap;Pe=new WeakMap;P=new WeakMap;R=new WeakMap;ie=new WeakMap;Ie=new WeakSet;ht=function(e){if(e.video){if(!bi.includes(e.video.codec))throw new Error(`Unsupported video codec: ${e.video.codec}`);if(e.video.rotation!==void 0&&![0,90,180,270].includes(e.video.rotation))throw new Error(`Invalid video rotation: ${e.video.rotation}. Has to be 0, 90, 180 or 270.`)}if(e.audio&&!Ei.includes(e.audio.codec))throw new Error(`Unsupported audio codec: ${e.audio.codec}`);if(e.firstTimestampBehavior&&!ki.includes(e.firstTimestampBehavior))throw new Error(`Invalid first timestamp behavior: ${e.firstTimestampBehavior}`);if(typeof e.fastStart=="object"){if(e.video&&e.fastStart.expectedVideoChunks===void 0)throw new Error("'fastStart' is an object but is missing property 'expectedVideoChunks'.");if(e.audio&&e.fastStart.expectedAudioChunks===void 0)throw new Error("'fastStart' is an object but is missing property 'expectedAudioChunks'.")}else if(![!1,"in-memory","fragmented"].includes(e.fastStart))throw new Error("'fastStart' option must be false, 'in-memory', 'fragmented' or an object.")};ke=new WeakSet;ut=function(){if(i(this,l).writeBox(zt({holdsAvc:i(this,h).video?.codec==="avc",fragmented:i(this,h).fastStart==="fragmented"})),C(this,ge,i(this,l).pos),i(this,h).fastStart==="in-memory")C(this,b,Te(!1));else if(i(this,h).fastStart!=="fragmented"){if(typeof i(this,h).fastStart=="object"){let e=m(this,Re,dt).call(this);i(this,l).seek(i(this,l).pos+e)}C(this,b,Te(!0)),i(this,l).writeBox(i(this,b))}m(this,K,re).call(this)};Re=new WeakSet;dt=function(){if(typeof i(this,h).fastStart!="object")return;let e=0,t=[i(this,h).fastStart.expectedVideoChunks,i(this,h).fastStart.expectedAudioChunks];for(let s of t)s&&(e+=8*Math.ceil(2/3*s),e+=4*s,e+=12*Math.ceil(2/3*s),e+=4*s,e+=8*s);return e+=4096,e};Ae=new WeakSet;ft=function(){if(i(this,h).video&&C(this,S,{id:1,info:{type:"video",codec:i(this,h).video.codec,width:i(this,h).video.width,height:i(this,h).video.height,rotation:i(this,h).video.rotation??0},timescale:11520,codecPrivate:new Uint8Array(0),samples:[],finalizedChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]}),i(this,h).audio){let e=m(this,We,mt).call(this,2,i(this,h).audio.sampleRate,i(this,h).audio.numberOfChannels);C(this,y,{id:i(this,h).video?2:1,info:{type:"audio",codec:i(this,h).audio.codec,numberOfChannels:i(this,h).audio.numberOfChannels,sampleRate:i(this,h).audio.sampleRate},timescale:i(this,h).audio.sampleRate,codecPrivate:e,samples:[],finalizedChunks:[],currentChunk:null,firstTimestamp:void 0,lastTimestamp:-1,timeToSampleTable:[],lastTimescaleUnits:null,lastSample:null,compactlyCodedChunkTable:[]})}};We=new WeakSet;mt=function(e,t,s){let r=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350].indexOf(t),n=s,u="";u+=e.toString(2).padStart(5,"0"),u+=r.toString(2).padStart(4,"0"),r===15&&(u+=t.toString(2).padStart(24,"0")),u+=n.toString(2).padStart(4,"0");let d=Math.ceil(u.length/8)*8;u=u.padEnd(d,"0");let g=new Uint8Array(u.length/8);for(let T=0;T<u.length;T+=8)g[T/8]=parseInt(u.slice(T,T+8),2);return g};fe=new WeakSet;Me=function(e,t,s,a,r,n){let u=a/1e6,d=r/1e6;return u=m(this,Fe,ct).call(this,u,e),n?.decoderConfig?.description&&(e.codecPrivate=new Uint8Array(n.decoderConfig.description)),{timestamp:u,duration:d,data:t,size:t.byteLength,type:s,timescaleUnitsToNextSample:x(d,e.timescale)}};z=new WeakSet;O=function(e,t){if(i(this,h).fastStart!=="fragmented"&&e.samples.push(t),e.lastTimescaleUnits!==null){let a=x(t.timestamp,e.timescale,!1),r=Math.round(a-e.lastTimescaleUnits);if(e.lastTimescaleUnits+=r,e.lastSample.timescaleUnitsToNextSample=r,i(this,h).fastStart!=="fragmented"){let n=H(e.timeToSampleTable);n.sampleCount===1?(n.sampleDelta=r,n.sampleCount++):n.sampleDelta===r?n.sampleCount++:(n.sampleCount--,e.timeToSampleTable.push({sampleCount:2,sampleDelta:r}))}}else e.lastTimescaleUnits=0,i(this,h).fastStart!=="fragmented"&&e.timeToSampleTable.push({sampleCount:1,sampleDelta:x(t.duration,e.timescale)});e.lastSample=t;let s=!1;if(!e.currentChunk)s=!0;else{let a=t.timestamp-e.currentChunk.startTimestamp;if(i(this,h).fastStart==="fragmented"){let r=i(this,S)??i(this,y);e===r&&t.type==="key"&&a>=1&&(s=!0,m(this,Ce,He).call(this))}else s=a>=.5}s&&(e.currentChunk&&m(this,se,we).call(this,e),e.currentChunk={startTimestamp:t.timestamp,samples:[]}),e.currentChunk.samples.push(t)};Fe=new WeakSet;ct=function(e,t){if(i(this,h).firstTimestampBehavior==="strict"&&t.lastTimestamp===-1&&e!==0)throw new Error(`The first chunk for your media track must have a timestamp of 0 (received ${e}). Non-zero first timestamps are often caused by directly piping frames or audio data from a MediaStreamTrack into the encoder. Their timestamps are typically relative to the age of the document, which is probably what you want.

If you want to offset all timestamps of a track such that the first one is zero, set firstTimestampBehavior: 'offset' in the options.
`);if(i(this,h).firstTimestampBehavior==="offset"&&(t.firstTimestamp===void 0&&(t.firstTimestamp=e),e-=t.firstTimestamp),e<t.lastTimestamp)throw new Error(`Timestamps must be monotonically increasing (went from ${t.lastTimestamp*1e6} to ${e*1e6}).`);return t.lastTimestamp=e,e};se=new WeakSet;we=function(e){if(i(this,h).fastStart==="fragmented")throw new Error("Can't finalize individual chunks 'fastStart' is set to 'fragmented'.");if(e.currentChunk){if(e.finalizedChunks.push(e.currentChunk),i(this,G).push(e.currentChunk),(e.compactlyCodedChunkTable.length===0||H(e.compactlyCodedChunkTable).samplesPerChunk!==e.currentChunk.samples.length)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:e.currentChunk.samples.length}),i(this,h).fastStart==="in-memory"){e.currentChunk.offset=0;return}e.currentChunk.offset=i(this,l).pos;for(let t of e.currentChunk.samples)i(this,l).write(t.data),t.data=null;m(this,K,re).call(this)}};Ce=new WeakSet;He=function(e=!0){if(i(this,h).fastStart!=="fragmented")throw new Error("Can't finalize a fragment unless 'fastStart' is set to 'fragmented'.");let t=[i(this,S),i(this,y)].filter(d=>d&&d.currentChunk);if(t.length===0)return;let s=kt(this,Pe)._++;if(s===1){let d=le(t,i(this,j),!0);i(this,l).writeBox(d)}let a=i(this,l).pos,r=Je(s,t);i(this,l).writeBox(r);{let d=Te(!1),g=0;for(let q of t)for(let M of q.currentChunk.samples)g+=M.size;let T=i(this,l).measureBox(d)+g;T>=2**32&&(d.largeSize=!0,T=i(this,l).measureBox(d)+g),d.size=T,i(this,l).writeBox(d)}for(let d of t){d.currentChunk.offset=i(this,l).pos,d.currentChunk.moofOffset=a;for(let g of d.currentChunk.samples)i(this,l).write(g.data),g.data=null}let n=i(this,l).pos;i(this,l).seek(i(this,l).offsets.get(r));let u=Je(s,t);i(this,l).writeBox(u),i(this,l).seek(n);for(let d of t)d.finalizedChunks.push(d.currentChunk),i(this,G).push(d.currentChunk),d.currentChunk=null;e&&m(this,K,re).call(this)};K=new WeakSet;re=function(){i(this,l)instanceof rt&&i(this,l).flush()};me=new WeakSet;ze=function(){if(i(this,ie))throw new Error("Cannot add new video or audio chunks after the file has been finalized.")};var vt=Math.PI*2,gt=1e6,Ai=128e3,Mi=1e6,Ne=44100;async function Ve(e){let{spinner:t,speedRpm:s}=e;t.stop();let a=new pt({target:new Le,video:{codec:"avc",width:t.canvas.width,height:t.canvas.height},audio:e.audio?{codec:"aac",sampleRate:Ne,numberOfChannels:1}:void 0,fastStart:"in-memory"}),n=60/s*3;if(e.audio){let _=new AudioEncoder({output:(oe,bt)=>{a.addAudioChunk(oe,bt)},error:oe=>{alert(oe),console.error(oe)}});_.configure({codec:"mp4a.40.2",sampleRate:Ne,numberOfChannels:1,bitrate:Ai});let ne=await new AudioContext({sampleRate:Ne}).decodeAudioData(e.audio);n=ne.duration;let _t=new AudioData({sampleRate:ne.sampleRate,numberOfChannels:1,numberOfFrames:ne.length,timestamp:0,data:ne.getChannelData(0),format:"f32-planar"});_.encode(_t),await _.flush()}let u=new VideoEncoder({output:(_,Z)=>{a.addVideoChunk(_,Z)},error:_=>{alert(_),console.error(_)}});u.configure({codec:"avc1.4d0028",width:t.canvas.width,height:t.canvas.height,bitrate:Mi});let d=0,g=0,T=n*gt;for(;g<T;){let _=d%vt;t.renderFrame(_);let Z=new VideoFrame(t.canvas,{timestamp:g});u.encode(Z),Z.close(),g+=gt/e.fps,d+=s/60*vt/e.fps}await u.flush(),a.finalize(),t.start();let{buffer:q}=a.target,M=new Blob([q],{type:"video/mp4"});return URL.createObjectURL(M)}var Se=1024,N=document.querySelector(".preview-canvas");N.width=Se;N.height=Se;var qe=document.querySelector(".speed-input"),$e=document.querySelector(".background-color-input"),wt=document.querySelector(".image-input"),Ct=document.querySelector(".audio-input"),je=document.querySelector(".padding-input"),Ge=document.querySelector(".show-hole-input"),zi=document.querySelectorAll(".download-button"),St=new Image;St.src="sample.jpg";var V={paddingPercent:parseInt(je.value),speedRpm:parseFloat(qe.value),backgroundColor:$e.value,showCenterHole:Ge.checked,image:St},yt=null;$e.addEventListener("input",()=>{V.backgroundColor=$e.value});qe.addEventListener("input",()=>V.speedRpm=parseFloat(qe.value));wt.addEventListener("input",()=>{let e=wt.files?.[0];if(!e)return;let t=new FileReader;t.addEventListener("load",()=>{V.image.src=t.result}),t.readAsDataURL(e)});Ct.addEventListener("input",async()=>{let e=Ct.files?.[0];if(!e)return;let t=new FileReader;yt=await new Promise(a=>{t.onload=()=>{a(t.result)},t.readAsArrayBuffer(e)})});je.addEventListener("input",()=>{V.paddingPercent=parseInt(je.value)});Ge.addEventListener("input",()=>{V.showCenterHole=Ge.checked});var Tt=new Y(N,V);Tt.start();async function Bi(e){if(!(e.target instanceof HTMLButtonElement))return;let t=e.target.textContent,{dataset:s}=e.target;if(!s.fps||!s.size){alert("Error: download button missing required attributes");return}let a=parseInt(s.fps),r=parseInt(s.size);e.target.disabled=!0,e.target.textContent="Generating video (please hold)...",N.width=r,N.height=r,await new Promise(d=>setTimeout(d,20));let n=await Ve({speedRpm:V.speedRpm,spinner:Tt,fps:a,audio:yt}),u=document.createElement("a");u.href=n,u.download="spinner.mp4",u.click(),N.width=Se,N.height=Se,e.target.disabled=!1,e.target.textContent=t}for(let e of zi)e.addEventListener("click",Bi);
